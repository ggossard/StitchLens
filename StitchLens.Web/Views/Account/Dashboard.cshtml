@model StitchLens.Web.Models.DashboardViewModel
@using StitchLens.Data.Models
@{
    ViewData["Title"] = "My Account";
}

<!-- Dashboard Hero Section -->
<section class="dashboard-hero-section">
    <div class="container">
        <div class="dashboard-hero-content">
            <div>
                <h1 class="dashboard-hero-title">Welcome Back!</h1>
                <p class="dashboard-hero-subtitle">Here's what's happening with your account</p>
            </div>
            @if (Model.CurrentTier != SubscriptionTier.PayAsYouGo) {
                <div class="dashboard-tier-badge tier-badge-@Model.CurrentTier.ToString().ToLower()">
                    <i class="fas fa-crown"></i>
                    <span>@Model.TierDisplayName Member</span>
                </div>
            }
        </div>
    </div>
</section>

<div class="container dashboard-container">

    <!-- Top Row: Subscription + Account Info -->
    <div class="row g-4 mb-4">
        <!-- Current Plan Card -->
        <div class="col-md-6">
            <div class="dashboard-card dashboard-card-plan">
                <div class="dashboard-card-header">
                    <i class="fas fa-star card-header-icon"></i>
                    <h3>Current Plan</h3>
                </div>
                <div class="dashboard-card-body">
                    <div class="plan-name">@Model.TierDisplayName</div>
                    <p class="plan-description">@Model.TierDescription</p>

                    @if (Model.HasActiveSubscription) {
                        <div class="plan-details">
                            <div class="plan-detail-row">
                                <span class="detail-label">Monthly Price</span>
                                <span class="detail-value">$@Model.MonthlyPrice.ToString("F2")</span>
                            </div>
                            <div class="plan-detail-row">
                                <span class="detail-label">Next Billing</span>
                                <span class="detail-value">@Model.NextBillingDate?.ToString("MMM d, yyyy")</span>
                            </div>
                            <div class="plan-detail-row">
                                <span class="detail-label">Status</span>
                                <span class="detail-value">
                                    <span class="status-badge status-active">
                                        <i class="fas fa-check-circle"></i> Active
                                    </span>
                                </span>
                            </div>
                        </div>
                    }
                    else if (Model.CurrentTier == SubscriptionTier.PayAsYouGo) {
                        <div class="upgrade-prompt">
                            <div class="upgrade-icon">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <div>
                                <h5>Ready to Unlock More?</h5>
                                <p>Upgrade for higher limits and premium features</p>
                            </div>
                        </div>
                    }

                    <div class="plan-actions">
                        @if (Model.CurrentTier == SubscriptionTier.PayAsYouGo) {
                            <a asp-controller="Home" asp-action="Pricing" class="btn btn-primary">
                                <i class="fas fa-arrow-up me-2"></i>Upgrade Now
                            </a>
                        }
                        else {
                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#cancelModal">
                                <i class="fas fa-times me-2"></i>Cancel Subscription
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Information Card -->
        <div class="col-md-6">
            <div class="dashboard-card dashboard-card-info">
                <div class="dashboard-card-header">
                    <i class="fas fa-user card-header-icon"></i>
                    <h3>Account Information</h3>
                </div>
                <div class="dashboard-card-body">
                    <div class="info-list">
                        <div class="info-item">
                            <i class="fas fa-envelope info-icon"></i>
                            <div>
                                <div class="info-label">Email</div>
                                <div class="info-value">@Model.User.Email</div>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-user-circle info-icon"></i>
                            <div>
                                <div class="info-label">Account Type</div>
                                <div class="info-value">@Model.User.UserType</div>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-calendar-alt info-icon"></i>
                            <div>
                                <div class="info-label">Member Since</div>
                                <div class="info-value">@Model.User.CreatedAt.ToLocalTime().ToString("MMM d, yyyy")</div>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-folder info-icon"></i>
                            <div>
                                <div class="info-label">Total Patterns</div>
                                <div class="info-value">
                                    <span class="pattern-count">@Model.User.Projects.Count</span> patterns
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="account-actions">
                        <button class="btn btn-outline-secondary" disabled>
                            <i class="fas fa-key me-2"></i>Change Password
                        </button>
                        <a asp-action="MyPatterns" class="btn btn-outline-primary">
                            <i class="fas fa-folder me-2"></i>My Patterns
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Usage Stats Card -->
    <div class="dashboard-card dashboard-card-usage mb-4">
        <div class="dashboard-card-header">
            <i class="fas fa-chart-bar card-header-icon"></i>
            <h3>Usage This Month</h3>
        </div>
        <div class="dashboard-card-body">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="usage-section">
                        <h5 class="usage-title">Patterns Created This Month</h5>
                        <div class="usage-stats">
                            <span class="usage-current">@Model.PatternsCreatedThisMonth of @Model.PatternCreationQuota</span>
                            <span class="usage-remaining">@Model.PatternsRemaining remaining</span>
                        </div>
                        <div class="usage-progress">
                            <div class="usage-progress-bar usage-progress-@(Model.PatternCreationPercentage > 80 ? "warning" : "success")"
                                 style="width: @Model.PatternCreationPercentage%">
                                <span>@Model.PatternCreationPercentage%</span>
                            </div>
                        </div>
                        @if (Model.PatternCreationPercentage > 80) {
                            <div class="usage-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                Running low on monthly pattern creations!
                            </div>
                        }
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="usage-section">
                        <h5 class="usage-title">Patterns Created Today</h5>
                        <div class="stat-display">
                            <div class="stat-number">@Model.PatternsCreatedToday</div>
                            <div class="stat-label">
                                patterns created<br>
                                <span class="stat-date">@DateTime.Today.ToString("MMM d, yyyy")</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Card -->
    <div class="dashboard-card dashboard-card-actions mb-4">
        <div class="dashboard-card-header">
            <i class="fas fa-bolt card-header-icon"></i>
            <h3>Quick Actions</h3>
        </div>
        <div class="dashboard-card-body">
            <div class="quick-actions-grid">
                <a asp-controller="Pattern" asp-action="Upload" class="quick-action-btn quick-action-primary">
                    <i class="fas fa-plus-circle"></i>
                    <span>Create Pattern</span>
                </a>
                <a asp-action="MyPatterns" class="quick-action-btn quick-action-secondary">
                    <i class="fas fa-folder-open"></i>
                    <span>View Patterns</span>
                </a>
                <button class="quick-action-btn quick-action-secondary" disabled>
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </button>
                @if (Model.CurrentTier == SubscriptionTier.PayAsYouGo) {
                    <a asp-controller="Home" asp-action="Pricing" class="quick-action-btn quick-action-success">
                        <i class="fas fa-arrow-up"></i>
                        <span>Upgrade Plan</span>
                    </a>
                }
                else {
                    <button class="quick-action-btn quick-action-secondary" disabled>
                        <i class="fas fa-receipt"></i>
                        <span>Billing History</span>
                    </button>
                }
            </div>
        </div>
    </div>

    <!-- Recent Payments -->
    @if (Model.RecentPayments.Any()) {
        <div class="dashboard-card dashboard-card-payments">
            <div class="dashboard-card-header">
                <i class="fas fa-credit-card card-header-icon"></i>
                <h3>Recent Payments</h3>
            </div>
            <div class="dashboard-card-body">
                <div class="payments-table-wrapper">
                    <table class="payments-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Type</th>
                                <th class="text-end">Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var payment in Model.RecentPayments) {
                                <tr>
                                    <td class="payment-date">@payment.CreatedAt.ToLocalTime().ToString("MMM d, yyyy")</td>
                                    <td class="payment-desc">@payment.Description</td>
                                    <td>
                                        @switch (payment.Type) {
                                            case PaymentType.SubscriptionRecurring:
                                                <span class="payment-type-badge type-recurring">
                                                    <i class="fas fa-sync"></i> Recurring
                                                </span>
                                                break;
                                            case PaymentType.SubscriptionInitial:
                                                <span class="payment-type-badge type-initial">
                                                    <i class="fas fa-star"></i> Initial
                                                </span>
                                                break;
                                            case PaymentType.OneTimePattern:
                                                <span class="payment-type-badge type-onetime">
                                                    <i class="fas fa-file"></i> One-Time
                                                </span>
                                                break;
                                            case PaymentType.Refund:
                                                <span class="payment-type-badge type-refund">
                                                    <i class="fas fa-undo"></i> Refund
                                                </span>
                                                break;
                                        }
                                    </td>
                                    <td class="payment-amount text-end">$@payment.Amount.ToString("F2")</td>
                                    <td>
                                        @switch (payment.Status) {
                                            case PaymentStatus.Succeeded:
                                                <span class="payment-status-badge status-success">
                                                    <i class="fas fa-check"></i> Succeeded
                                                </span>
                                                break;
                                            case PaymentStatus.Pending:
                                                <span class="payment-status-badge status-pending">
                                                    <i class="fas fa-clock"></i> Pending
                                                </span>
                                                break;
                                            case PaymentStatus.Failed:
                                                <span class="payment-status-badge status-failed">
                                                    <i class="fas fa-times"></i> Failed
                                                </span>
                                                break;
                                            case PaymentStatus.Refunded:
                                                <span class="payment-status-badge status-refunded">
                                                    <i class="fas fa-undo"></i> Refunded
                                                </span>
                                                break;
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

<!-- Cancel Subscription Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content auth-modal">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2" style="color: var(--color-warm-gray);"></i>
                    Cancel Subscription
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Are you sure you want to cancel your subscription?</strong></p>
                <p class="text-muted">
                    You'll continue to have access until @Model.NextBillingDate?.ToString("MMMM d, yyyy"),
                    then your account will revert to the Free tier.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Keep Subscription
                </button>
                <form asp-action="CancelSubscription" method="post" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times me-2"></i>Yes, Cancel
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
