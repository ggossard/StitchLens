@{
    ViewData["Title"] = "Create Your Pattern";
}

<!-- Upload Hero Section -->
<section class="upload-hero-section">
    <div class="container">
        <div class="text-center mb-5">
            <h1 class="upload-hero-title">Bring Your Vision to Life</h1>
            <p class="upload-hero-subtitle">
                Choose a treasured photo and we'll transform it into a beautiful needlepoint pattern.
                <br>Every stitch tells a story.
            </p>
        </div>
    </div>
</section>

<div class="container mb-5">
    @* Sign-in prompt for guests - styled version *@
    @if (User.Identity?.IsAuthenticated != true) {
        <div class="save-patterns-prompt">
            <div class="row align-items-center">
                <div class="col-md-1 text-center">
                    <i class="fas fa-heart prompt-icon"></i>
                </div>
                <div class="col-md-11">
                    <h5 class="prompt-heading">Save Your Patterns Forever</h5>
                    <p class="prompt-text">Create a free account to save your patterns, download them anytime, and build your personal collection.</p>
                    <div class="prompt-buttons">
                        <a asp-controller="Account" asp-action="Register" class="btn btn-primary btn-sm">
                            <i class="fas fa-user-plus me-1"></i> Create Free Account
                        </a>
                        <span class="prompt-divider">or</span>
                        <form asp-controller="Account" asp-action="ExternalLogin" asp-route-returnUrl="/Pattern/Upload" method="post" class="d-inline">
                            <button type="submit" name="provider" value="Google" class="btn btn-outline-danger btn-sm">
                                <i class="fab fa-google me-1"></i> Google
                            </button>
                        </form>
                        <form asp-controller="Account" asp-action="ExternalLogin" asp-route-returnUrl="/Pattern/Upload" method="post" class="d-inline">
                            <button type="submit" name="provider" value="Facebook" class="btn btn-outline-primary btn-sm">
                                <i class="fab fa-facebook-f me-1"></i> Facebook
                            </button>
                        </form>
                    </div>
                    <small class="prompt-signin">Already have an account? <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="/Pattern/Upload">Sign in here</a></small>
                </div>
            </div>
        </div>
    }

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <form method="post" enctype="multipart/form-data" asp-action="ProcessUpload" id="uploadForm">

                <!-- Step 1: File Selection -->
                <div id="uploadSection">
                    <div class="upload-card">
                        <div class="upload-card-header">
                            <div class="step-indicator">
                                <span class="step-number">1</span>
                                <span class="step-label">Choose Your Photo</span>
                            </div>
                        </div>
                        <div class="upload-card-body">
                            <div class="upload-dropzone">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h4 class="upload-instruction">Select a Photo to Transform</h4>
                                <p class="upload-help">
                                    Choose a favorite memory - family portraits, beloved pets, or special places work beautifully.
                                </p>
                                <label for="imageFile" class="btn btn-primary btn-lg upload-btn">
                                    <i class="fas fa-image me-2"></i> Browse Your Photos
                                </label>
                                <input type="file"
                                       class="d-none"
                                       id="imageFile"
                                       name="imageFile"
                                       accept="image/jpeg,image/png,image/jpg"
                                       required>
                                <p class="upload-format-note mt-3">
                                    <i class="fas fa-info-circle"></i> JPG or PNG format � Recommended: 500-2000 pixels
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Cropping Interface (hidden initially) -->
                <div id="cropSection" style="display: none;">
                    <div class="upload-card">
                        <div class="upload-card-header">
                            <div class="step-indicator">
                                <span class="step-number">2</span>
                                <span class="step-label">Perfect Your Composition</span>
                            </div>
                            <p class="crop-instruction">Drag to select the area you want to stitch. We'll handle the rest!</p>
                        </div>
                        <div class="upload-card-body">
                            <div class="row">
                                <div class="col-lg-9 mb-4 mb-lg-0">
                                    <div class="crop-image-container">
                                        <img id="cropImage" style="max-width: 100%;">
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div class="crop-tools-panel">
                                        <h6 class="tools-heading">Crop Tools</h6>
                                        <div class="tool-group">
                                            <button type="button" class="tool-btn" onclick="cropper.reset()">
                                                <i class="fas fa-undo"></i> Reset
                                            </button>
                                            <button type="button" class="tool-btn" onclick="cropper.clear()">
                                                <i class="fas fa-times"></i> Clear
                                            </button>
                                            <button type="button" class="tool-btn" onclick="cropper.setDragMode('move')">
                                                <i class="fas fa-arrows-alt"></i> Move Image
                                            </button>
                                            <button type="button" class="tool-btn" onclick="cropper.setDragMode('crop')">
                                                <i class="fas fa-crop"></i> Crop Area
                                            </button>
                                        </div>

                                        <div class="tools-divider"></div>

                                        <h6 class="tools-heading">Crop Shape</h6>
                                        <div class="tool-group" id="shapeToolGroup">
                                            <button type="button" class="tool-btn tool-btn-shape active" data-shape="Rectangle" onclick="setCropShape('Rectangle')">
                                                Rectangle
                                            </button>
                                            <button type="button" class="tool-btn tool-btn-shape" data-shape="Circle" onclick="setCropShape('Circle')">
                                                Circle
                                            </button>
                                            <button type="button" class="tool-btn tool-btn-shape" data-shape="Oval" onclick="setCropShape('Oval')">
                                                Oval
                                            </button>
                                        </div>

                                        <div class="tools-divider"></div>

                                        <h6 class="tools-heading">Aspect Ratio</h6>
                                        <div class="tool-group">
                                            <button type="button" class="tool-btn tool-btn-aspect" onclick="setAspectRatio(NaN)">
                                                Free Form
                                            </button>
                                            <button type="button" class="tool-btn tool-btn-aspect" onclick="setAspectRatio(1)">
                                                Square (1:1)
                                            </button>
                                            <button type="button" class="tool-btn tool-btn-aspect" onclick="setAspectRatio(4/3)">
                                                Standard (4:3)
                                            </button>
                                            <button type="button" class="tool-btn tool-btn-aspect" onclick="setAspectRatio(16/9)">
                                                Wide (16:9)
                                            </button>
                                        </div>
                                        <p class="small text-muted mt-2 mb-0">Outside circle/oval stays transparent (unstitched).</p>

                                        <div class="tools-divider"></div>

                                        <div class="crop-info-box">
                                            <i class="fas fa-ruler-combined"></i>
                                            <div>
                                                <strong>Crop Size</strong>
                                                <div id="cropInfo" class="crop-size-text">Select an area</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden fields to store crop data -->
                    <input type="hidden" name="cropX" id="cropX">
                    <input type="hidden" name="cropY" id="cropY">
                    <input type="hidden" name="cropWidth" id="cropWidth">
                    <input type="hidden" name="cropHeight" id="cropHeight">
                    <input type="hidden" name="cropShape" id="cropShape" value="Rectangle">
                    <input type="hidden" name="originalWidth" id="originalWidth">
                    <input type="hidden" name="originalHeight" id="originalHeight">
                </div>

                <div asp-validation-summary="All" class="text-danger mt-3"></div>

                <!-- Action Buttons -->
                <div class="upload-actions">
                    <button type="button" id="cancelCrop" class="btn btn-outline-secondary btn-lg" style="display: none;" onclick="cancelCrop()">
                        <i class="fas fa-chevron-left me-2"></i> Choose Different Photo
                    </button>
                    <button type="submit" id="continueBtn" class="btn btn-primary btn-lg" style="display: none;">
                        Continue to Canvas Settings <i class="fas fa-chevron-right ms-2"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        #cropSection.crop-shape-ellipse .cropper-view-box,
        #cropSection.crop-shape-ellipse .cropper-face {
            border-radius: 50%;
        }
    </style>

    <script>
        let cropper = null;
        let naturalWidth = 0;
        let naturalHeight = 0;
        let selectedCropShape = 'Rectangle';
        let selectedAspectRatio = NaN;

        function setAspectRatio(ratio) {
            selectedAspectRatio = ratio;

            if (!cropper) return;

            const finalRatio = selectedCropShape === 'Circle' ? 1 : ratio;
            cropper.setAspectRatio(finalRatio);
        }

        function setCropShape(shape) {
            selectedCropShape = shape;
            document.getElementById('cropShape').value = shape;

            document.querySelectorAll('.tool-btn-shape').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.shape === shape);
            });

            const cropSection = document.getElementById('cropSection');
            cropSection.classList.toggle('crop-shape-ellipse', shape === 'Circle' || shape === 'Oval');

            if (!cropper) return;

            if (shape === 'Circle') {
                cropper.setAspectRatio(1);
            } else {
                cropper.setAspectRatio(selectedAspectRatio);
            }
        }

        // Handle file selection
        document.getElementById('imageFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File is too large. Please choose an image under 10MB.');
                this.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function (event) {
                // First, load image to get TRUE natural dimensions
                const tempImg = new Image();
                tempImg.onload = function () {
                    // Store the true natural dimensions
                    naturalWidth = tempImg.naturalWidth;
                    naturalHeight = tempImg.naturalHeight;

                    console.log('True image dimensions:', naturalWidth, 'x', naturalHeight);

                    // Now show crop section
                    document.getElementById('uploadSection').style.display = 'none';
                    document.getElementById('cropSection').style.display = 'block';
                    document.getElementById('cancelCrop').style.display = 'inline-block';
                    document.getElementById('continueBtn').style.display = 'inline-block';

                    // Smooth scroll to crop section
                    document.getElementById('cropSection').scrollIntoView({ behavior: 'smooth', block: 'start' });

                    // Set image and initialize cropper
                    const image = document.getElementById('cropImage');
                    image.src = event.target.result;

                    // Destroy previous cropper if exists
                    if (cropper) {
                        cropper.destroy();
                    }

                    // Initialize Cropper.js
                    cropper = new Cropper(image, {
                        viewMode: 1,
                        dragMode: 'move',
                        aspectRatio: selectedCropShape === 'Circle' ? 1 : selectedAspectRatio,
                        autoCropArea: 0.8,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                        ready: function () {
                            // Store original dimensions
                            document.getElementById('originalWidth').value = naturalWidth;
                            document.getElementById('originalHeight').value = naturalHeight;
                            setCropShape(selectedCropShape);
                            console.log('Cropper ready. Natural size:', naturalWidth, 'x', naturalHeight);
                        },
                        crop: function (event) {
                            // Cropper.js getData() returns coordinates in natural image size!
                            const data = cropper.getData();

                            console.log('getData() result:', data);
                            console.log('Natural dimensions:', naturalWidth, 'x', naturalHeight);

                            // Round to integers and constrain to bounds
                            let cropX = Math.max(0, Math.round(data.x));
                            let cropY = Math.max(0, Math.round(data.y));
                            let cropWidth = Math.round(data.width);
                            let cropHeight = Math.round(data.height);

                            // Ensure crop doesn't exceed image bounds
                            if (cropX + cropWidth > naturalWidth) {
                                cropWidth = naturalWidth - cropX;
                            }
                            if (cropY + cropHeight > naturalHeight) {
                                cropHeight = naturalHeight - cropY;
                            }

                            console.log('Final crop:', { cropX, cropY, cropWidth, cropHeight });
                            console.log('Bounds check:',
                                'X+W:', cropX + cropWidth, '<=', naturalWidth, '?', (cropX + cropWidth <= naturalWidth),
                                'Y+H:', cropY + cropHeight, '<=', naturalHeight, '?', (cropY + cropHeight <= naturalHeight)
                            );

                            // Update display
                            document.getElementById('cropInfo').innerHTML =
                                `${cropWidth} � ${cropHeight}px`;

                            // Store crop data
                            document.getElementById('cropX').value = cropX;
                            document.getElementById('cropY').value = cropY;
                            document.getElementById('cropWidth').value = cropWidth;
                            document.getElementById('cropHeight').value = cropHeight;
                        }
                    });
                };
                tempImg.src = event.target.result;
            };

            reader.readAsDataURL(file);
        });

        // Cancel crop and go back to file selection
        function cancelCrop() {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }

            document.getElementById('imageFile').value = '';
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('cropSection').style.display = 'none';
            document.getElementById('cancelCrop').style.display = 'none';
            document.getElementById('continueBtn').style.display = 'none';
            naturalWidth = 0;
            naturalHeight = 0;
            selectedCropShape = 'Rectangle';
            selectedAspectRatio = NaN;
            setCropShape('Rectangle');

            // Scroll back to top
            document.getElementById('uploadSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Validate crop data before form submission
        document.getElementById('uploadForm').addEventListener('submit', function (e) {
            console.log('Form submitting. Crop data:', {
                cropX: document.getElementById('cropX').value,
                cropY: document.getElementById('cropY').value,
                cropWidth: document.getElementById('cropWidth').value,
                cropHeight: document.getElementById('cropHeight').value,
                cropShape: document.getElementById('cropShape').value,
                originalWidth: document.getElementById('originalWidth').value,
                originalHeight: document.getElementById('originalHeight').value
            });

            if (!cropper) {
                e.preventDefault();
                alert('Please select and crop an image first.');
                return false;
            }

            // Ensure crop data is set
            const cropWidth = parseInt(document.getElementById('cropWidth').value);
            const cropHeight = parseInt(document.getElementById('cropHeight').value);
            const cropX = parseInt(document.getElementById('cropX').value);
            const cropY = parseInt(document.getElementById('cropY').value);

            if (!cropWidth || cropWidth <= 0 || !cropHeight || cropHeight <= 0) {
                e.preventDefault();
                alert('Please select a valid crop area.');
                return false;
            }

            // Client-side bounds check
            if (cropX + cropWidth > naturalWidth || cropY + cropHeight > naturalHeight) {
                e.preventDefault();
                alert(`Crop area (${cropX + cropWidth} x ${cropY + cropHeight}) exceeds image bounds (${naturalWidth} x ${naturalHeight}). Please try again.`);
                console.error('Crop bounds exceeded!');
                return false;
            }

            console.log('Validation passed, submitting...');
        });
    </script>
}
