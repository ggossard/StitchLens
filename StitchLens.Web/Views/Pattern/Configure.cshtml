@model StitchLens.Web.Models.ConfigureViewModel
@{
    ViewData["Title"] = "Customize Your Pattern";
}

<script type="text/javascript">
    // Serialize the brands
    var allYarnBrands = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.AllYarnBrands));
</script>

<!-- Configure Hero Section -->
<section class="configure-hero-section">
    <div class="container">
        <div class="text-center">
            <h1 class="configure-hero-title">Perfect Your Canvas</h1>
            <p class="configure-hero-subtitle">
                Customize every detail to match your vision. We'll handle the technical work—
                <br>you focus on creating something beautiful.
            </p>
        </div>
    </div>
</section>

<div class="container mb-5">
    <div class="row">
        <!-- Left side: Image preview & Info -->
        <div class="col-lg-5 mb-4 mb-lg-0">
            <!-- Image Preview Card -->
            <div class="configure-card sticky-preview">
                <div class="configure-card-header">
                    <div class="preview-icon">
                        <i class="fas fa-image"></i>
                    </div>
                    <h5 class="preview-title">Your Design</h5>
                </div>
                <div class="configure-card-body text-center">
                    <div class="image-preview-container">
                        <img src="@Model.ImageUrl"
                             alt="Your uploaded image"
                             class="img-fluid preview-image">
                    </div>
                </div>
            </div>

            <!-- Pattern Size Info Card -->
            <div class="configure-card mt-3">
                <div class="configure-card-body">
                    <div class="pattern-info-header">
                        <i class="fas fa-ruler-combined"></i>
                        <h6>Pattern Specifications</h6>
                    </div>

                    <div class="pattern-spec">
                        <span class="spec-label">Canvas Size:</span>
                        <span class="spec-value" id="canvasSize">@Model.WidthInches.ToString("F1")" × @Model.HeightInches.ToString("F1")"</span>
                    </div>

                    <div class="pattern-spec">
                        <span class="spec-label">Grid Dimensions:</span>
                        <span class="spec-value" id="stitchCount">@Model.WidthStitches × @Model.HeightStitches stitches</span>
                    </div>

                    <div class="pattern-spec-total">
                        <span class="spec-label-total">Total Stitches:</span>
                        <span class="spec-value-total" id="totalStitches">@((Model.WidthStitches * Model.HeightStitches).ToString("N0"))</span>
                    </div>
                </div>
            </div>

            <!-- Helpful Tip Card -->
            <div class="helpful-tip-card mt-3">
                <div class="tip-icon">
                    <i class="fas fa-lightbulb"></i>
                </div>
                <div class="tip-content">
                    <h6 class="tip-title">Crafting Tip</h6>
                    <p class="tip-text">
                        Not sure about size? A 10" × 10" pattern at 14 count makes a lovely pillow front.
                        Smaller works beautifully as ornaments or framed pieces!
                    </p>
                </div>
            </div>
        </div>

        <!-- Right side: Settings form -->
        <div class="col-lg-7">
            <form asp-action="Configure" method="post" id="configureForm">
                <input type="hidden" asp-for="ProjectId" />
                <input type="hidden" asp-for="ImageUrl" />

                <!-- Step 1: Project Information -->
                <div class="configure-card mb-3">
                    <div class="configure-card-header">
                        <div class="step-indicator-small">
                            <span class="step-number-small">1</span>
                            <span class="step-label-small">Project Information</span>
                        </div>
                    </div>
                    <div class="configure-card-body">
                        <div class="form-group-custom mb-3">
                            <label asp-for="Title" class="form-label-custom">
                                <i class="fas fa-tag label-icon"></i>
                                Project Title
                            </label>
                            <input asp-for="Title"
                                   type="text"
                                   class="form-control-custom"
                                   placeholder="e.g., 'Sunset Beach Memory' or 'Bella's Portrait'"
                                   maxlength="200">
                            <span asp-validation-for="Title" class="text-danger"></span>
                            <div class="form-help-text">
                                <i class="fas fa-info-circle"></i>
                                Give your pattern a name that captures the memory
                            </div>
                        </div>

                        <div class="form-group-custom mb-0">
                            <label asp-for="CraftType" class="form-label-custom">
                                <i class="fas fa-palette label-icon"></i>
                                I'm Making A
                            </label>
                            <select asp-for="CraftType"
                                    asp-items="Model.CraftTypeOptions"
                                    class="form-select-custom"
                                    id="craftType">
                            </select>
                            <div class="craft-type-info">
                                <div class="craft-type-option">
                                    <strong>Needlepoint:</strong> Wool yarn on canvas with tent/basketweave stitches
                                </div>
                                <div class="craft-type-option">
                                    <strong>Cross-Stitch:</strong> Cotton floss on fabric with counted crosses
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Canvas Settings -->
                <div class="configure-card mb-3">
                    <div class="configure-card-header">
                        <div class="step-indicator-small">
                            <span class="step-number-small">2</span>
                            <span class="step-label-small" id="canvasLabel">Canvas Settings</span>
                        </div>
                    </div>
                    <div class="configure-card-body">
                        <!-- Mesh Count -->
                        <div class="form-group-custom mb-3">
                            <label asp-for="MeshCount" class="form-label-custom">
                                <i class="fas fa-th label-icon"></i>
                                <span id="meshLabel">Mesh Count</span>
                            </label>
                            <select asp-for="MeshCount"
                                    asp-items="Model.MeshCountOptions"
                                    class="form-select-custom"
                                    id="meshCount">
                            </select>
                            <div class="form-help-text" id="meshHelp">
                                <i class="fas fa-info-circle"></i>
                                Higher mesh = smaller stitches and more intricate detail
                            </div>
                        </div>

                        <!-- Dimensions -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="WidthInches" class="form-label-custom">
                                    <i class="fas fa-arrows-alt-h label-icon"></i>
                                    Width (inches)
                                </label>
                                <input asp-for="WidthInches"
                                       type="number"
                                       step="0.1"
                                       min="1"
                                       max="36"
                                       class="form-control-custom dimension-input"
                                       id="widthInches">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="HeightInches" class="form-label-custom">
                                    <i class="fas fa-arrows-alt-v label-icon"></i>
                                    Height (inches)
                                </label>
                                <input asp-for="HeightInches"
                                       type="number"
                                       step="0.1"
                                       min="1"
                                       max="36"
                                       class="form-control-custom dimension-input"
                                       id="heightInches">
                            </div>
                        </div>

                        <!-- Stitch Type -->
                        <div class="form-group-custom mb-0">
                            <label asp-for="StitchType" class="form-label-custom">
                                <i class="fas fa-grip-lines label-icon"></i>
                                Stitch Type
                            </label>
                            <select asp-for="StitchType"
                                    asp-items="Model.StitchTypeOptions"
                                    class="form-select-custom"
                                    id="StitchType">
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Color & Materials -->
                <div class="configure-card mb-3">
                    <div class="configure-card-header">
                        <div class="step-indicator-small">
                            <span class="step-number-small">3</span>
                            <span class="step-label-small">Colors & Materials</span>
                        </div>
                    </div>
                    <div class="configure-card-body">
                        <!-- Max Colors with Visual Slider -->
                        <div class="form-group-custom mb-3">
                            <label asp-for="MaxColors" class="form-label-custom">
                                <i class="fas fa-fill-drip label-icon"></i>
                                Color Complexity: <span class="color-count-badge" id="colorDisplay">@Model.MaxColors colors</span>
                            </label>
                            <input asp-for="MaxColors"
                                   type="range"
                                   min="10"
                                   max="60"
                                   step="1"
                                   class="form-range-custom"
                                   id="maxColors">
                            <div class="range-labels">
                                <span class="range-label-start">
                                    <i class="fas fa-circle-notch"></i> Simpler (10)
                                </span>
                                <span class="range-label-end">
                                    More Detail (60) <i class="fas fa-circle"></i>
                                </span>
                            </div>
                            <div class="form-help-text">
                                <i class="fas fa-info-circle"></i>
                                Fewer colors create a simplified, artistic look. More colors capture fine details.
                            </div>
                        </div>

                        <!-- Yarn Brand -->
                        <div class="form-group-custom mb-3">
                            <label asp-for="YarnBrandId" class="form-label-custom">
                                <i class="fas fa-store label-icon"></i>
                                <span id="yarnLabel">Yarn Brand</span>
                            </label>
                            <select asp-for="YarnBrandId"
                                    asp-items="Model.YarnBrands"
                                    class="form-select-custom"
                                    id="YarnBrandId">
                                <option value="">-- Select a brand --</option>
                            </select>
                            <div class="form-help-text" id="yarnHelp">
                                <i class="fas fa-info-circle"></i>
                                We'll match colors to your preferred brand's real yarns
                            </div>
                        </div>

                        <!-- Transparency Support -->
                        <div class="form-group-custom mb-0">
                            <div class="custom-checkbox-card">
                                <div class="checkbox-wrapper">
                                    <input asp-for="PreserveTransparency"
                                           type="checkbox"
                                           class="form-check-input-custom"
                                           id="preserveTransparency">
                                    <label asp-for="PreserveTransparency" class="checkbox-label-custom">
                                        <div class="checkbox-title">
                                            <i class="fas fa-cut"></i>
                                            Preserve Transparent Areas
                                        </div>
                                        <div class="checkbox-description">
                                            Leave transparent areas unstitched for shaped designs (ornaments, bookmarks, irregular projects)
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div asp-validation-summary="All" class="text-danger mt-3"></div>

                <!-- Action Buttons -->
                <div class="configure-actions">
                    <button type="submit" class="btn btn-primary btn-lg btn-generate">
                        <i class="fas fa-magic me-2"></i> Generate My Pattern
                    </button>
                    <a asp-action="Upload" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-chevron-left me-2"></i> Start Over
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Terminology mappings
        const terminology = {
            needlepoint: {
                canvas: 'Canvas',
                mesh: 'Mesh Count',
                meshHelp: 'Higher mesh = smaller stitches and more intricate detail',
                yarn: 'Yarn Brand',
                yarnHelp: 'We\'ll match colors to your preferred brand\'s real yarns',
                meshOptions: [
                    { value: '10', text: '10 mesh (large stitches)' },
                    { value: '13', text: '13 mesh (standard)' },
                    { value: '14', text: '14 mesh' },
                    { value: '18', text: '18 mesh (fine detail)' }
                ],
                stitchOptions: [
                    { value: 'Tent', text: 'Tent Stitch' },
                    { value: 'Basketweave', text: 'Basketweave' },
                    { value: 'Continental', text: 'Continental' }
                ]
            },
            crossstitch: {
                canvas: 'Fabric',
                mesh: 'Fabric Count',
                meshHelp: 'Higher count = smaller stitches and more intricate detail',
                yarn: 'Floss Brand',
                yarnHelp: 'We\'ll match colors to your preferred brand\'s real floss',
                meshOptions: [
                    { value: '11', text: '11 count' },
                    { value: '14', text: '14 count (standard)' },
                    { value: '16', text: '16 count' },
                    { value: '18', text: '18 count (fine detail)' },
                    { value: '28', text: '28 count' }
                ],
                stitchOptions: [
                    { value: 'Full Cross', text: 'Full Cross Stitch' },
                    { value: 'Half Cross', text: 'Half Cross Stitch' },
                    { value: 'Backstitch', text: 'Backstitch' }
                ]
            }
        };

        // Update yarn brand dropdown based on craft type
        function updateYarnBrands(craftType) {
            const yarnSelect = document.getElementById('YarnBrandId');
            if (!yarnSelect) {
                console.error('YarnBrandId select not found!');
                return;
            }

            const currentValue = yarnSelect.value;

            // Filter brands by craft type (0 = Needlepoint, 1 = CrossStitch)
            const filteredBrands = allYarnBrands.filter(b => {
                return b.CraftType === parseInt(craftType);
            });

            // Clear and repopulate
            yarnSelect.innerHTML = '<option value="">-- Select a brand --</option>';
            filteredBrands.forEach(brand => {
                const option = new Option(brand.Name, brand.Id);
                yarnSelect.add(option);
            });

            // Restore selection if still valid for this craft type
            const stillValid = filteredBrands.some(b => b.Id.toString() === currentValue);
            if (stillValid) {
                yarnSelect.value = currentValue;
            }
        }

        // Update stitch type dropdown based on craft type
        function updateStitchTypes(terms) {
            const stitchSelect = document.getElementById('StitchType');
            if (!stitchSelect) return;

            const currentValue = stitchSelect.value;

            // Clear and repopulate
            stitchSelect.innerHTML = '';
            terms.stitchOptions.forEach(opt => {
                const option = new Option(opt.text, opt.value);
                stitchSelect.add(option);
            });

            // Restore selection if valid, otherwise use first option
            if (terms.stitchOptions.some(opt => opt.value === currentValue)) {
                stitchSelect.value = currentValue;
            } else {
                stitchSelect.value = terms.stitchOptions[0].value;
            }
        }

        // Update terminology based on craft selection
        function updateTerminology() {
            const craftType = document.getElementById('craftType').value;
            const terms = craftType === '1' ? terminology.crossstitch : terminology.needlepoint;

            // Update labels
            document.getElementById('canvasLabel').textContent = terms.canvas + ' Settings';
            document.getElementById('meshLabel').textContent = terms.mesh;
            document.getElementById('meshHelp').innerHTML = '<i class="fas fa-info-circle"></i> ' + terms.meshHelp;
            document.getElementById('yarnLabel').textContent = terms.yarn;
            document.getElementById('yarnHelp').innerHTML = '<i class="fas fa-info-circle"></i> ' + terms.yarnHelp;

            // Update mesh count options
            const meshSelect = document.getElementById('meshCount');
            const currentValue = meshSelect.value;

            // Clear and repopulate
            meshSelect.innerHTML = '';
            terms.meshOptions.forEach(opt => {
                const option = new Option(opt.text, opt.value);
                meshSelect.add(option);
            });

            // Restore selection if valid, otherwise default to 14
            if (terms.meshOptions.some(opt => opt.value === currentValue)) {
                meshSelect.value = currentValue;
            } else {
                meshSelect.value = '14';
            }

            // Update stitch type options
            updateStitchTypes(terms);

            // Update yarn brands for this craft type
            updateYarnBrands(craftType);

            // Trigger calculation update
            updateCalculations();
        }

        // Listen for craft type changes
        document.getElementById('craftType').addEventListener('change', updateTerminology);

        // Initialize on page load
        updateTerminology();

        // Update color count display as slider moves
        document.getElementById('maxColors').addEventListener('input', function(e) {
            document.getElementById('colorDisplay').textContent = e.target.value + ' colors';
        });

        // Update stitch count calculations when dimensions or mesh change
        function updateCalculations() {
            const meshCount = parseInt(document.getElementById('meshCount').value);
            const widthInches = parseFloat(document.getElementById('widthInches').value);
            const heightInches = parseFloat(document.getElementById('heightInches').value);

            if (meshCount && widthInches && heightInches) {
                const widthStitches = Math.round(widthInches * meshCount);
                const heightStitches = Math.round(heightInches * meshCount);
                const totalStitches = widthStitches * heightStitches;

                document.getElementById('canvasSize').textContent =
                    widthInches.toFixed(1) + '" × ' + heightInches.toFixed(1) + '"';
                document.getElementById('stitchCount').textContent =
                    widthStitches + ' × ' + heightStitches + ' stitches';
                document.getElementById('totalStitches').textContent =
                    totalStitches.toLocaleString();
            }
        }

        document.getElementById('meshCount').addEventListener('change', updateCalculations);
        document.getElementById('widthInches').addEventListener('input', updateCalculations);
        document.getElementById('heightInches').addEventListener('input', updateCalculations);
    </script>
}