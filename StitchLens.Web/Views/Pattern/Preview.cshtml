@model StitchLens.Web.Models.PreviewViewModel
@{
    ViewData["Title"] = "Pattern Preview";
}

<div class="container mt-4">
    <h2>Your Needlepoint Pattern</h2>
    <p class="lead">@Model.Project.Title</p>
    
    <div class="row">
        <!-- Original Image -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Original Image</h5>
                </div>
                <div class="card-body text-center">
                    <img src="/uploads/@System.IO.Path.GetFileName(Model.Project.OriginalImagePath)" 
                         alt="Original" 
                         class="img-fluid"
                         style="max-height: 400px;">
                </div>
            </div>
        </div>
        
        <!-- Quantized Preview -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Pattern Preview (@Model.Project.MaxColors Colors)</h5>
                </div>
                <div class="card-body text-center">
                    @if (!string.IsNullOrEmpty(Model.Project.ProcessedImagePath))
                    {
                        <img src="/uploads/@System.IO.Path.GetFileName(Model.Project.ProcessedImagePath)" 
                             alt="Quantized" 
                             class="img-fluid"
                             style="max-height: 400px;">
                    }
                    else
                    {
                        <p class="text-muted">Processing...</p>
                    }
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pattern Info -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5>Canvas Specifications</h5>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Mesh Count:</strong></td>
                            <td>@Model.Project.MeshCount count</td>
                        </tr>
                        <tr>
                            <td><strong>Finished Size:</strong></td>
                            <td>@Model.Project.WidthInches.ToString("F1")" × @Model.Project.HeightInches.ToString("F1")"</td>
                        </tr>
                        <tr>
                            <td><strong>Total Stitches:</strong></td>
                            <td>@Model.TotalStitches.ToString("N0")</td>
                        </tr>
                        <tr>
                            <td><strong>Stitch Type:</strong></td>
                            <td>@Model.Project.StitchType</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        
        @if (Model.HasYarnMatching)
        {
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5>Yarn Summary</h5>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Brand:</strong></td>
                                <td>@Model.Project.YarnBrand?.Name</td>
                            </tr>
                            <tr>
                                <td><strong>Total Colors:</strong></td>
                                <td>@Model.YarnMatches!.Count</td>
                            </tr>
                            <tr>
                                <td><strong>Total Yards:</strong></td>
                                <td>@Model.TotalYardsNeeded yards</td>
                            </tr>
                            <tr>
                                <td><strong>Total Skeins:</strong></td>
                                <td>@Model.TotalSkeinsNeeded skeins</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h5>Ready to Stitch!</h5>
                        <p class="mb-2">Your pattern is complete with yarn matching</p>
                        <a asp-action="DownloadPdf" asp-route-id="@Model.Project.Id"
                           class="btn btn-light btn-lg mt-2">
                            <i class="bi bi-file-pdf"></i> Download PDF
                        </a>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="col-md-8">
                <div class="card bg-warning">
                    <div class="card-body">
                        <h5>⚠️ No Yarn Brand Selected</h5>
                        <p>Go back to settings and select a yarn brand to get your shopping list!</p>
                        <a asp-action="Configure" asp-route-id="@Model.Project.Id" class="btn btn-primary">
                            Select Yarn Brand
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>
    
    <!-- Yarn Shopping List -->
    @if (Model.HasYarnMatching)
    {
        <div class="card mt-4">
            <div class="card-header">
                <h5>
                    <i class="bi bi-cart"></i> Shopping List - @Model.Project.YarnBrand?.Name Yarn
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 80px;">Color</th>
                                <th>Code</th>
                                <th>Name</th>
                                <th class="text-end">Stitches</th>
                                <th class="text-end">Yards</th>
                                <th class="text-end">Skeins</th>
                                <th class="text-end">Match Quality</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var yarn in Model.YarnMatches!)
                            {
                                var percentage = Model.TotalStitches > 0 
                                    ? (yarn.StitchCount * 100.0 / Model.TotalStitches).ToString("F1")
                                    : "0";
                                
                                var matchQuality = yarn.DeltaE < 2.0 ? "Excellent" 
                                    : yarn.DeltaE < 5.0 ? "Good" 
                                    : yarn.DeltaE < 10.0 ? "Fair" 
                                    : "Poor";
                                
                                var matchBadgeClass = yarn.DeltaE < 2.0 ? "success" 
                                    : yarn.DeltaE < 5.0 ? "info" 
                                    : yarn.DeltaE < 10.0 ? "warning" 
                                    : "danger";
                                
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div style="width: 50px; height: 50px; background-color: @yarn.HexColor; border: 1px solid #ccc; border-radius: 4px;"></div>
                                        </div>
                                    </td>
                                    <td class="align-middle">
                                        <strong>@yarn.Code</strong>
                                    </td>
                                    <td class="align-middle">@yarn.Name</td>
                                    <td class="align-middle text-end">
                                        @yarn.StitchCount.ToString("N0")
                                        <small class="text-muted d-block">(@percentage%)</small>
                                    </td>
                                    <td class="align-middle text-end">@yarn.YardsNeeded</td>
                                    <td class="align-middle text-end">
                                        <strong>@yarn.EstimatedSkeins</strong>
                                    </td>
                                    <td class="align-middle text-end">
                                        <span class="badge bg-@matchBadgeClass">
                                            @matchQuality
                                        </span>
                                        <small class="text-muted d-block">ΔE: @yarn.DeltaE.ToString("F1")</small>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="fw-bold">
                                <td colspan="3" class="text-end">TOTALS:</td>
                                <td class="text-end">@Model.TotalStitches.ToString("N0")</td>
                                <td class="text-end">@Model.TotalYardsNeeded</td>
                                <td class="text-end">@Model.TotalSkeinsNeeded</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="alert alert-info mt-3">
                    <h6><i class="bi bi-info-circle"></i> Shopping Tips:</h6>
                    <ul class="mb-0">
                        <li><strong>Match Quality</strong> shows how close the yarn color is to your image</li>
                        <li><span class="badge bg-success">Excellent</span> = Nearly identical (ΔE &lt; 2)</li>
                        <li><span class="badge bg-info">Good</span> = Very close match (ΔE 2-5)</li>
                        <li><span class="badge bg-warning">Fair</span> = Acceptable (ΔE 5-10)</li>
                        <li><span class="badge bg-danger">Poor</span> = Noticeable difference (ΔE &gt; 10)</li>
                        <li>Yarn estimates include a small buffer - you may need less</li>
                        <li>Consider buying an extra skein of your most-used colors</li>
                        <li>Dye lots can vary - buy all yarn for one project at once</li>
                    </ul>
                </div>
            </div>
        </div>
    }
    
    <!-- Color Palette (if no yarn matching) -->
    @if (!Model.HasYarnMatching && Model.UnmatchedColors != null)
    {
        <div class="card mt-4">
            <div class="card-header">
                <h5>Color Palette (@Model.UnmatchedColors.Count colors)</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    @foreach (var color in Model.UnmatchedColors)
                    {
                        var hexColor = $"#{color.R:X2}{color.G:X2}{color.B:X2}";
                        var percentage = Model.TotalStitches > 0 
                            ? (color.PixelCount * 100.0 / Model.TotalStitches).ToString("F1")
                            : "0";
                        
                        <div class="col-md-3 col-sm-4 col-6 mb-3">
                            <div class="d-flex align-items-center">
                                <div style="width: 60px; height: 60px; background-color: @hexColor; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px;"></div>
                                <div>
                                    <strong class="d-block">@hexColor</strong>
                                    <small class="text-muted">@color.PixelCount px (@percentage%)</small>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
    
    <!-- Action Buttons -->
    <div class="mt-4 d-flex gap-2">
        <a asp-action="Configure" asp-route-id="@Model.Project.Id" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Adjust Settings
        </a>
        <a asp-action="Upload" class="btn btn-outline-secondary">
            <i class="bi bi-upload"></i> Start New Pattern
        </a>
        @if (Model.HasYarnMatching) {
            <a asp-action="DownloadPdf" asp-route-id="@Model.Project.Id"
               class="btn btn-success">
                <i class="bi bi-file-pdf"></i> Download Pattern PDF
            </a>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Print function for shopping list
        function printShoppingList() {
            window.print();
        }
    </script>
}