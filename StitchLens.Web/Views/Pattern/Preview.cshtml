@model StitchLens.Web.Models.PreviewViewModel
@using StitchLens.Data.Models
@{
    ViewData["Title"] = "Your Beautiful Pattern";
    var craftName = Model.CraftType == CraftType.Needlepoint ? "Needlepoint" : "Cross-Stitch";
    var materialName = Model.CraftType == CraftType.Needlepoint ? "Canvas" : "Fabric";
    var countLabel = Model.CraftType == CraftType.Needlepoint ? "Mesh Count" : "Fabric Count";
    var threadType = Model.CraftType == CraftType.Needlepoint ? "Yarn" : "Floss";
}

<!-- Preview Hero Section -->
<section class="preview-hero-section">
    <div class="container">
        <div class="text-center">
            <div class="hero-icon-badge">
                <i class="fas fa-check-circle"></i>
            </div>
            <h1 class="preview-hero-title">Your Pattern is Ready!</h1>
            <h2 class="preview-project-title">@Model.Project.Title</h2>
            <p class="preview-hero-subtitle">
                Your @craftName pattern is complete and ready to bring to life.
                Every stitch will be a step toward creating something truly special.
            </p>
        </div>
    </div>
</section>

<div class="container mb-5">

    <!-- Image Comparison -->
    <div class="comparison-section">
        <div class="row g-4">
            <!-- Original Image -->
            <div class="col-lg-6">
                <div class="preview-card">
                    <div class="preview-card-header">
                        <div class="preview-card-icon">
                            <i class="fas fa-image"></i>
                        </div>
                        <h5 class="preview-card-title">Your Original Photo</h5>
                    </div>
                    <div class="preview-card-body">
                        <div class="image-comparison-container">
                            <img src="/uploads/@System.IO.Path.GetFileName(Model.Project.OriginalImagePath)"
                                 alt="Your original photo"
                                 class="img-fluid comparison-image">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pattern Preview -->
            <div class="col-lg-6">
                <div class="preview-card">
                    <div class="preview-card-header">
                        <div class="preview-card-icon pattern-icon">
                            <i class="fas fa-th"></i>
                        </div>
                        <h5 class="preview-card-title">Your Stitching Pattern</h5>
                        <span class="color-count-badge-small">@Model.Project.MaxColors colors</span>
                    </div>
                    <div class="preview-card-body">
                        @if (!string.IsNullOrEmpty(Model.Project.ProcessedImagePath)) {
                            <div class="image-comparison-container">
                                <img src="/uploads/@System.IO.Path.GetFileName(Model.Project.ProcessedImagePath)"
                                     alt="Your stitching pattern"
                                     class="img-fluid comparison-image">
                            </div>
                        }
                        else {
                            <div class="processing-placeholder">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Processing your pattern...</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pattern Specifications & Download -->
    <div class="row g-4 mt-2">
        <!-- Canvas Specifications -->
        <div class="col-lg-4">
            <div class="preview-card specs-card">
                <div class="preview-card-header">
                    <div class="preview-card-icon">
                        <i class="fas fa-ruler-combined"></i>
                    </div>
                    <h5 class="preview-card-title">@materialName Details</h5>
                </div>
                <div class="preview-card-body">
                    <div class="spec-row">
                        <span class="spec-label">@countLabel:</span>
                        <span class="spec-value">@Model.Project.MeshCount count</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">Finished Size:</span>
                        <span class="spec-value">@Model.Project.WidthInches.ToString("F1")" × @Model.Project.HeightInches.ToString("F1")"</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">Total Stitches:</span>
                        <span class="spec-value">@Model.TotalStitches.ToString("N0")</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">Stitch Type:</span>
                        <span class="spec-value">@Model.Project.StitchType</span>
                    </div>
                </div>
            </div>
        </div>

        @if (Model.HasYarnMatching) {
            <!-- Materials Summary -->
            <div class="col-lg-4">
                <div class="preview-card specs-card">
                    <div class="preview-card-header">
                        <div class="preview-card-icon">
                            <i class="fas fa-spool"></i>
                        </div>
                        <h5 class="preview-card-title">@threadType Summary</h5>
                    </div>
                    <div class="preview-card-body">
                        <div class="spec-row">
                            <span class="spec-label">Brand:</span>
                            <span class="spec-value">@Model.Project.YarnBrand?.Name</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Total Colors:</span>
                            <span class="spec-value">@Model.YarnMatches!.Count</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Total Yards:</span>
                            <span class="spec-value">@Model.TotalYardsNeeded.ToString("F2")</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Total Skeins:</span>
                            <span class="spec-value">@Model.TotalSkeinsRoundedUp</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Download Card -->
            <div class="col-lg-4">
                @if (Model.QuotaExceeded) {
                    <div class="preview-card download-card quota-exceeded">
                        <div class="preview-card-body text-center">
                            <div class="quota-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h5 class="quota-title">Pattern Creation Limit Reached</h5>
                            <p class="quota-text">
                                You've created <strong>@Model.PatternsCreatedThisMonth of @Model.PatternCreationQuota</strong> patterns this month
                            </p>
                            <a asp-controller="Home" asp-action="Pricing" class="btn btn-primary btn-lg">
                                <i class="fas fa-arrow-up me-2"></i> Upgrade to Create More
                            </a>
                            <p class="quota-note">
                                @if (Model.CurrentTier == SubscriptionTier.PayAsYouGo) {
                                    <text>Get 10-100 patterns per month!</text>
                                }
                                else {
                                    <text>Resets on your next billing date</text>
                                }
                            </p>
                        </div>
                    </div>
                }
                else {
                    <div class="preview-card download-card ready-to-download">
                        <div class="preview-card-body text-center">
                            <div class="download-icon">
                                <i class="fas fa-heart"></i>
                            </div>
                            <h5 class="download-title">Ready to Create!</h5>
                            <p class="download-text">
                                Your pattern includes color matching, shopping list, and stitch chart
                            </p>

                            <div class="color-grid-option">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="useColoredGrid" checked>
                                    <label class="form-check-label" for="useColoredGrid">
                                        <i class="fas fa-palette me-1"></i> Colored grid
                                    </label>
                                </div>
                                <small class="form-text">Best for color printers. Uncheck for black & white.</small>
                            </div>

                            <a href="#" id="downloadPdfBtn" class="btn btn-primary btn-lg download-btn">
                                <i class="fas fa-download me-2"></i> Download Your Pattern
                            </a>

                            <p class="downloads-remaining">
                                <i class="fas fa-check-circle"></i> @Model.PatternsCreatedThisMonth of @Model.PatternCreationQuota patterns created this month
                            </p>
                        </div>
                    </div>
                }
            </div>
        }
        else {
            <!-- No Yarn Brand Selected -->
            <div class="col-lg-8">
                <div class="preview-card no-yarn-card">
                    <div class="preview-card-body text-center">
                        <div class="warning-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <h5 class="warning-title">Choose Your @threadType Brand</h5>
                        <p class="warning-text">
                            Select a @threadType.ToLower() brand to get accurate color matching and a complete shopping list
                        </p>
                        <a asp-action="Configure" asp-route-id="@Model.Project.Id" class="btn btn-primary btn-lg">
                            <i class="fas fa-arrow-left me-2"></i> Select @threadType Brand
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Shopping List -->
    @if (Model.HasYarnMatching) {
        <div class="preview-card shopping-list-card mt-4">
            <div class="preview-card-header">
                <div class="preview-card-icon">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <h5 class="preview-card-title">Your Shopping List</h5>
                <span class="shopping-list-subtitle">@Model.Project.YarnBrand?.Name @threadType</span>
            </div>
            <div class="preview-card-body">
                <div class="table-responsive">
                    <table class="shopping-table">
                        <thead>
                            <tr>
                                <th>Color</th>
                                <th>Code</th>
                                <th>Name</th>
                                <th class="text-end">Stitches</th>
                                <th class="text-end">Yards</th>
                                <th class="text-end">Skeins</th>
                                <th class="text-end">Match</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var yarn in Model.YarnMatches!) {
                                var percentage = Model.TotalStitches > 0
                                ? (yarn.StitchCount * 100.0 / Model.TotalStitches).ToString("F1")
                                : "0";

                                var matchQuality = yarn.DeltaE < 2.0 ? "Excellent"
                                : yarn.DeltaE < 5.0 ? "Good"
                                : yarn.DeltaE < 10.0 ? "Fair"
                                : "Poor";

                                var matchBadgeClass = yarn.DeltaE < 2.0 ? "excellent"
                                : yarn.DeltaE < 5.0 ? "good"
                                : yarn.DeltaE < 10.0 ? "fair"
                                : "poor";

                                <tr>
                                    <td>
                                        <div class="color-swatch" style="background-color: @yarn.HexColor;"></div>
                                    </td>
                                    <td class="yarn-code">@yarn.Code</td>
                                    <td class="yarn-name">@yarn.Name</td>
                                    <td class="text-end">
                                        <div class="stitch-count">@yarn.StitchCount.ToString("N0")</div>
                                        <div class="stitch-percentage">@percentage%</div>
                                    </td>
                                    <td class="text-end yarn-yards">@yarn.YardsNeeded</td>
                                    <td class="text-end">
                                        <div class="skein-count">@( (int)Math.Ceiling(yarn.EstimatedSkeins) )</div>
                                        <div class="skein-percentage">@percentage% used</div>
                                    </td>
                                    <td class="text-end">
                                        <span class="match-badge match-@matchBadgeClass">
                                            @matchQuality
                                        </span>
                                        <div class="delta-e">ΔE: @yarn.DeltaE.ToString("F1")</div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="totals-row">
                                <td colspan="3" class="text-end"><strong>TOTALS:</strong></td>
                                <td class="text-end"><strong>@Model.TotalStitches.ToString("N0")</strong></td>
                                <td class="text-end"><strong>@Model.TotalYardsNeeded.ToString("F2")</strong></td>
                                <td class="text-end"><strong>@Model.TotalSkeinsRoundedUp</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Shopping Tips -->
                <div class="shopping-tips">
                    <div class="tips-header">
                        <i class="fas fa-lightbulb"></i>
                        <h6>Shopping Tips</h6>
                    </div>
                    <ul class="tips-list">
                        <li><strong>Match Quality:</strong> Shows color accuracy compared to your image</li>
                        <li><span class="match-badge match-excellent">Excellent</span> Nearly identical (ΔE &lt;2)</li>
                        <li><span class="match-badge match-good">Good</span> Very close (ΔE 2-5)</li>
                        <li><span class="match-badge match-fair">Fair</span> Acceptable (ΔE 5-10)</li>
                        <li><span class="match-badge match-poor">Poor</span> Noticeable difference (ΔE &gt;10)</li>
                        <li>Estimates include a buffer—you may need slightly less</li>
                        <li>Buy an extra skein of heavily-used colors for peace of mind</li>
                        <li>Purchase all @threadType.ToLower() at once to avoid dye lot variations</li>
                    </ul>
                </div>
            </div>
        </div>
    }

    <!-- Color Palette (if no yarn matching) -->
    @if (!Model.HasYarnMatching && Model.UnmatchedColors != null) {
        <div class="preview-card mt-4">
            <div class="preview-card-header">
                <div class="preview-card-icon">
                    <i class="fas fa-palette"></i>
                </div>
                <h5 class="preview-card-title">Color Palette (@Model.UnmatchedColors.Count colors)</h5>
            </div>
            <div class="preview-card-body">
                <div class="row g-3">
                    @foreach (var color in Model.UnmatchedColors) {
                        var hexColor = $"#{color.R:X2}{color.G:X2}{color.B:X2}";
                        var percentage = Model.TotalStitches > 0
                        ? (color.PixelCount * 100.0 / Model.TotalStitches).ToString("F1")
                        : "0";

                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <div class="palette-color-item">
                                <div class="palette-color-swatch" style="background-color: @hexColor;"></div>
                                <div class="palette-color-info">
                                    <div class="palette-color-hex">@hexColor</div>
                                    <div class="palette-color-usage">@color.PixelCount px (@percentage%)</div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Action Buttons -->
    <div class="preview-actions">
        <a asp-action="Configure" asp-route-id="@Model.Project.Id" class="btn btn-outline-secondary btn-lg">
            <i class="fas fa-sliders-h me-2"></i> Adjust Settings
        </a>
        <a asp-action="Upload" class="btn btn-outline-secondary btn-lg">
            <i class="fas fa-plus me-2"></i> Create New Pattern
        </a>
        @if (Model.HasYarnMatching && !Model.QuotaExceeded) {
            <a href="#" class="btn btn-primary btn-lg download-pdf-btn">
                <i class="fas fa-download me-2"></i> Download Pattern PDF
            </a>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Handle all download PDF buttons
        document.querySelectorAll('.download-pdf-btn, #downloadPdfBtn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();

                var useColor = document.getElementById('useColoredGrid')?.checked ?? true;
                var projectId = @Model.Project.Id;

                // Build download URL with color preference
                var url = '@Url.Action("DownloadPdf", "Pattern")?id=' + projectId + '&useColor=' + useColor;

                window.location.href = url;
            });
        });
    </script>
}
